@page "/workhistory/edit/{id:int}"
@using DataModels.ApplicationModels
@using EMPP_Server.Components.Pages.Comp
@using EMPP_Server.Infrastructure.Repositories.IMainInfoRepo
@using EMPP_Server.Infrastructure.Repositories.IRepo
@using EMPP_Server.Infrastructure.Repositories.WorkHistoryRepo

@inject IWorkHistoryRepo _work
@inject ISkillRepo _skill
@inject IInitialStage _main
@inject IJSRuntime _js
@inject NavigationManager _nav
@inject ISnackbar _snackbar
@inject IDialogService DialogService

<PageTitle>Work History</PageTitle>

<MudItem>
    <MudTimeline Reverse="true" TimelinePosition="TimelinePosition.Bottom" TimelineOrientation="TimelineOrientation.Horizontal">
        <MudTimelineItem>
            <MudText Align="Align.Center">Intake</MudText>
        </MudTimelineItem>
        <MudTimelineItem>
            <MudText Align="Align.Center">Main Information</MudText>
        </MudTimelineItem>
        <MudTimelineItem DotStyle="background-color: #ff0000">
            <MudText Align="Align.Center">Work History</MudText>
        </MudTimelineItem>
        <MudTimelineItem>
            <MudText Align="Align.Center">Education</MudText>
        </MudTimelineItem>
    </MudTimeline>
</MudItem>


@if (IsLoading)
{
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <MudAlert IsOpen="@IsLoading" Severity="Severity.Info">Loading...</MudAlert>
            </div>
        </div>
    </div>
}
else
{
    <main class="container">
        <div class="row">
            <div class="col-md-12">
                <MudPaper Elevation="4" Class="p-3">
                    <MudGrid Justify="Justify.SpaceBetween">
                        <MudItem>
                            <MudText Typo="Typo.h5">Application: @Application.FirstName @Application.LastName</MudText>
                        </MudItem>
                        <MudItem>
                            <MudButton Variant="MudBlazor.Variant.Filled" Color="Color.Primary" OnClick="AddWork">Add Work</MudButton>
                        </MudItem>
                    </MudGrid>
                    <MudTable Items="@WorkHistories" Dense="true" Hover="true" Bordered="true" Striped="true">
                        <ToolBarContent>
                            <MudText Typo="Typo.h6">Work History</MudText>
                            <MudSpacer />
                            <MudTextField @bind-Value="searchString1" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                        </ToolBarContent>
                        <HeaderContent>
                            <MudTh></MudTh>
                            <MudTh>Company Name</MudTh>
                            <MudTh>Position</MudTh>
                            <MudTh>Start Date</MudTh>
                            <MudTh>End Date</MudTh>
                            <MudTh>Skills</MudTh>
                            <MudTh></MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>
                                <MudIconButton Icon="@Icons.Material.Filled.RemoveCircle" Color="Color.Error" OnClick="() => DeleteWorkHistory(context.Id)" />
                            </MudTd>
                            <MudTd>@context.CompanyName</MudTd>
                            <MudTd>@context.Position</MudTd>
                            <MudTd>@context.StartDate.Value.ToString("d")</MudTd>
                            <MudTd>@context.EndDate.Value.ToString("d")</MudTd>
                            <MudTd>
                                @foreach (var item in context.Skills)
                                {
                                    //switch color based on skill level
                                    var color = item.SkillLevel switch
                                    {
                                        "Beginner" => MudBlazor.Color.Error,
                                        "Intermediate" => MudBlazor.Color.Warning,
                                        "Advanced" => MudBlazor.Color.Success,
                                        _ => MudBlazor.Color.Primary
                                    };


                                    <MudChip T="string" Color="color" OnClick="() => EditSkill(context.Id,item.Id)">@item.SkillName</MudChip>
                                }
                            </MudTd>
                            <MudTd>
                                <MudButton Variant="MudBlazor.Variant.Text" Color="Color.Warning" OnClick="() => AddSkill(context.Id)">Add Skill</MudButton>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudPaper>
                @*Next Button*@
                <MudPaper Elevation="4" Class="p-3 mt-3">
                    <MudGrid Justify="Justify.FlexEnd">
                        <MudItem>
                            <MudButton Variant="MudBlazor.Variant.Filled" Color="Color.Primary" OnClick='() => _nav.NavigateTo($"/language-data/{Id}" )'>Next</MudButton>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
   
            </div>
        </div>
    </main>

}



@code {
    [Parameter] public int Id { get; set; }

    public bool IsLoading { get; set; } = false;

    public string searchString1 { get; set; }

    public WorkHistoryDTO WorkHistory { get; set; } = new WorkHistoryDTO();

    public IEnumerable<WorkHistoryDTO> WorkHistories = new List<WorkHistoryDTO>();
    public IEnumerable<SkillDTO> Skills = new List<SkillDTO>();

    public InitialStageDTO Application { get; set; } = new InitialStageDTO();

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;
        await LoadApplication();
        await LoadWorkHistory();
        IsLoading = false;
    }

    private async Task LoadApplication()
    {
        Application = await _main.GetApplicationById(Id);
    }

    private async Task LoadWorkHistory()
    {
        WorkHistories = await _work.GetWorkHistoriesByAppIdAsync(Id);
        Skills = await _skill.GetAll();
    }

    private async Task DeleteWorkHistory(int id)
    {
        var confirm = await _js.InvokeAsync<bool>("confirm", "Are you sure?");
        if (confirm)
        {
            await _work.DeleteWorkHistoryAsync(id);
            await LoadWorkHistory();
        }
    }

    // open dialog
    private async Task AddWork()
    {
        var parameters = new DialogParameters<AddWork>
        {
            { x => x.AppId, Id},
            { x => x.Color, Color.Error }
        };

        var options = new MudBlazor.DialogOptions() { CloseOnEscapeKey = true, CloseButton = true, FullWidth = true };

        var dialog = await DialogService.ShowAsync<AddWork>("Add Work", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadWorkHistory();
            _snackbar.Add("Work History Added", Severity.Success);
        }

    }

    // Add Skill
    private async Task AddSkill(int id)
    {
        var parameters = new DialogParameters<AddSkill>
        {
            { x => x.WorkId, id},
            { x => x.Color, Color.Error },
            { x => x.IsNew, true }
        };

        var options = new MudBlazor.DialogOptions() { CloseOnEscapeKey = true, CloseButton = true, FullWidth = true };

        var dialog = await DialogService.ShowAsync<AddSkill>("Add Skill", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadWorkHistory();
            _snackbar.Add("Skill Added", Severity.Success);
        }

    }

    // Edit Skill
    private async Task EditSkill(int id, int skillId)
    {
        var parameters = new DialogParameters<AddSkill>
        {
            { x => x.WorkId, id},
            { x => x.Color, Color.Error },
            { x => x.IsNew, false },
            { x => x.SkillId, skillId}
        };

        var options = new MudBlazor.DialogOptions() { CloseOnEscapeKey = true, CloseButton = true, FullWidth = true };

        var dialog = await DialogService.ShowAsync<AddSkill>("Edit Skill", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadWorkHistory();
            _snackbar.Add("Skill Edited", Severity.Success);
        }

    }
}
